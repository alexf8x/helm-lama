kind: pipeline
type: docker
name: helm-lint

# Use docker:dind for running kind
services:
  - name: kubernetes
    image: docker:dind
    privileged: true
    volumes:
    - name: dockersock
      path: /var/run

volumes:
  - name: dockersock
    temp: {}
  - name: kubeconfig
    temp: {}

steps:

- name: create kind cluster
  image: otwld/drone-kind
  settings:
    verbose: 1
    cluster_name: "kind-default"
    hostname: "kubernetes" # Use same name as service`s name
  volumes:
    - name: dockersock
      path: /var/run
    - name: kubeconfig
      path: /root/.kube
  depends_on:
    - kubernetes
    - create kind cluster

# Add steps for interacting with your kind cluster
- name: kubectl example
  image: bitnami/kubectl
  commands:
    - kubectl cluster-info
  depends_on:
    - create kind cluster
  volumes:
    - name: kubeconfig
      path: /root/.kube

- name: setup-helm
  image: alpine/helm:3.5.4
  commands:
    - helm version

- name: helm-lint
  image: alpine/helm:3.5.4
  commands:
    - helm lint . -f values.yaml

- name: helm-install
  image: alpine/helm:3.5.4
  commands:
    - helm install test-release . -f values.yaml

- name: verify-deployment
  image: bitnami/kubectl:1.21
  commands:
    - kubectl get pods

- name: delete kind cluster
  image: otwld/drone-kind
  settings:
    clean: true
  volumes:
    - name: dockersock
      path: /var/run
    - name: kubeconfig
      path: /root/.kube
  depends_on:
    - kubernetes

trigger:
  event:
    - push
    - pull_request
  branch:
    - main

---
kind: pipeline
type: docker
name: publish


trigger:
  branch:
    - custom

steps:
  - name: publish helm chart to github pages
    image: otwld/drone-chart-releaser-github-pages
    settings:
      cr_token:
        from_secret: github_access_token
      skip_existing: true
      root_package: true
